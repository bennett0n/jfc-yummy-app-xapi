<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:apikit="http://www.mulesoft.org/schema/mule/mule-apikit" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd http://www.mulesoft.org/schema/mule/mule-apikit http://www.mulesoft.org/schema/mule/mule-apikit/current/mule-apikit.xsd http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd ">
   
	<sub-flow name="get-orders-sub-flow" doc:id="7e50e018-318b-4c31-9da9-cce448dc404c" >
		<set-variable value="#[attributes.uriParams]" doc:name="uriParams" doc:id="2d82ba79-617c-4975-b550-723e4a98144f" variableName="uriParams" />
		<try doc:name="Try" doc:id="0b4834a2-2b17-466f-aabb-39fcd190ea14">
            <http:request method="GET" doc:name="GET /orders/{orderId}" doc:id="de633175-1d26-4e7f-9a9b-f575a5aa9717" config-ref="OrderSAPI" path="${paths.get-orders}">
                <http:uri-params><![CDATA[#[output application/java
---
{
	"orderId" : p('app.order-prefix') ++ '@' ++ vars.uriParams.orderReference
}]]]></http:uri-params>
                <http:query-params><![CDATA[#[output application/java
---
{
	"source" : "Yummy App"
}]]]></http:query-params>
            </http:request>
            <error-handler>
                <on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="e63c50c6-304a-49ec-b4f1-4a61544232aa">
                    <raise-error doc:name="APP:NO_RECORD_FOUND" doc:id="c8706888-a5b2-47cf-914f-dcde82eb544e" type="APP:NO_RECORD_FOUND" />
                </on-error-propagate>
            </error-handler>
        </try>
		<ee:transform doc:name="Transform Message">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	orderReference: (payload.orderId splitBy "@")[1] default payload.orderId,
	customer: {
		name: payload.customer,
//		phone: payload.contact
	},
	items: payload.items map {
		id: $.productId,
		description: $.name,
		unitPrice: $.price,
		quantity: $.quantity
	},
	totalCost: payload.totalAmount,
	timestamp: payload.orderDate
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
	</sub-flow>
	<sub-flow name="post-order-sub-flow" doc:id="c45d6935-3340-47c8-acc5-52a7e082988a" >
		<set-variable value="#[payload]" doc:name="input_payload" doc:id="b6b64ef8-5248-47bd-8eae-4573ba954233" variableName="input_payload" />
		<ee:transform doc:name="payload to send" doc:id="6899a9a2-cd92-4a00-a8c8-d8e6821a02c8">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	orderId: p('app.order-prefix') ++ '@' ++ vars.input_payload.orderReference,
	source: p('app.order-source'),
	customerName: vars.input_payload.customer.name,
	contact: vars.input_payload.customer.phone,
	items: vars.input_payload.items map {
		productId: $.id,
		name: $.description,
		price: $.unitPrice,
		quantity: $.quantity	
	},
	totalAmount: vars.input_payload.totalCost,
	paymentType: vars.input_payload.paymentMethod,
	orderDate: vars.input_payload.timestamp	
	
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
		<try doc:name="Try" doc:id="d32b1dbc-ee01-4308-9b8b-deef6d74d319">
			<http:request method="POST" doc:name="POST /orders" doc:id="a74f606b-8bc6-4f63-9553-b84a9b92cc18" config-ref="OrderSAPI" path="${paths.post-orders}" />
			<error-handler>
				<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="0700dd7b-0e28-4e46-86f6-503ebbe88582">
					<set-variable value="#[error.errorMessage.payload.message]" doc:name="error_payload" doc:id="0428b814-ddbf-4a7d-bc77-ae3e3e4abb10" variableName="error_payload" />
					<raise-error doc:name="APP:POST_ORDER_ERROR" doc:id="b9b6d92e-7ea2-4d40-b3e9-58a3ebce45ec" type="APP:POST_ORDER_ERROR" />
				</on-error-propagate>
			</error-handler>
		</try>
		<ee:transform doc:name="Transform Message">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  message: "Order submitted"
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
	</sub-flow>
</mule>
